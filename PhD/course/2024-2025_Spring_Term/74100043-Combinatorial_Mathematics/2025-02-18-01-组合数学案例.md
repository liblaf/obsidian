---
date: 2025-02-18T09:27:00+08:00
modified: 2025-09-20T18:40:41+08:00
tags:
  - PhD/Course/Combinatorial_Mathematics
title: 组合数学案例
---

### 摘要

本报告旨在将组合数学课程中所学的核心概念 --- 包括排列组合、递归关系、组合优化、鸽巢原理等 --- 与 "光线追踪" (Ray Tracing) 相结合, 进行一次深入的交叉学科案例分析. 光线追踪, 作为一种模拟物理世界光照传播以生成逼真图像的算法, 其内在的计算过程、性能优化和理论框架, 无不与组合数学的原理息息相关. 本报告将逐一剖析这些联系, 展示组合数学作为一门基础学科, 如何为理解和解决计算机图形学中的前沿问题提供强有力的理论工具和思维框架.

### 1. 引言: 光线追踪与组合爆炸的挑战

首先, 让我们简要回顾一下光线追踪. 它的核心思想非常直观, 甚至可以说是一种 "暴力美学": 为了确定屏幕上一个像素的颜色, 我们从虚拟摄像机 (眼睛) 出发, 穿过这个像素, 向场景中发射一束虚拟的光线. 这束光线会与场景中的某个物体相交. 根据交点的材质、光照情况, 我们计算出这个点的颜色. 如果该物体是反射或折射的 (如镜子、水面) , 光线会继续弹射, 递归地重复这个过程, 直到光线射出场景或达到预设的弹射次数. 最终, 所有这些信息被收集起来, 汇聚成该像素的最终颜色.

这个过程听起来简单, 但在实践中, 我们立刻会面临一个核心的挑战: **组合爆炸 (Combinatorial Explosion)**.

- **路径的组合爆炸:** 想象一下, 一束光线在一个复杂的场景中弹射 10 次. 在每次弹射时, 它都可能射向半球空间内的无数个方向. 即使我们将其离散化, 比如每次弹射有 100 个可能的方向, 那么总的路径数量级也将是 $100^{10}$, 一个天文数字. 渲染方程 (Rendering Equation) 本质上就是对所有可能的光线传播路径进行积分, 这是一个无穷维度的组合问题.
- **计算量的组合爆炸:** 一个典型的场景可能包含数百万甚至数十亿个三角面片 (几何基元). 对于屏幕上每一个像素 (比如 4K 分辨率下有超过 800 万个像素), 发射出的每一条光线 (为了抗锯齿, 每个像素可能发射多条光线), 理论上都需要和场景中的每一个三角面片进行求交测试. 这导致了 `(像素数 x 每像素样本数 x 弹射次数) x 物体数量` 这样一个巨大的计算组合, 使得最朴素的光线追踪算法毫无实用性可言.

正因为光线追踪的本质是一个应对组合爆炸挑战的过程, 组合数学的原理才显得尤为重要. 它不仅帮助我们理解问题的规模, 更指导我们如何设计出高效的算法来 "修剪" 这个巨大的组合空间.

### 2. 递归关系: 光线追踪算法的数学本质

组合数学课程中一个重要的内容是 **递归关系 (Recurrence Relations)**. 一个序列的项可以通过其前一项或多项来定义, 这正是递归. 光线追踪的经典算法 --- Whitted-style Ray Tracing, 其结构就是一种天然的递归关系.

我们可以将像素颜色的计算过程定义为一个函数 `Trace(ray)`, 其返回值是光线 `ray` 所能 "看到" 的颜色. 这个函数的行为可以被一个递归关系所描述:

`Color(ray) =`
1. 找到 `ray` 与场景的第一个交点 `P`.
2. 如果未找到交点, 返回背景色 (**递归基/Base Case**).
3. 如果交点 `P` 所在的物体是光源, 返回光源颜色 (**递归基/Base Case**).
4. 否则, 在 `P` 点进行着色计算:
	- `LocalColor =` 计算 `P` 点的直接光照 (例如, 从 `P` 点向光源发射光线, 看是否被遮挡).
	- `ReflectedColor = 0`, `RefractedColor = 0`.
	- 如果 `P` 的材质是反射性的, 生成反射光线 `reflected_ray`, 则 `ReflectedColor = material.reflectivity * Trace(reflected_ray)`.
	- 如果 `P` 的材质是折射性的, 生成折射光线 `refracted_ray`, 则 `RefractedColor = material.transparency * Trace(refracted_ray)`.
5. `return LocalColor + ReflectedColor + RefractedColor`.

这里的 `Trace(ray)` 的定义中包含了对 `Trace(reflected_ray)` 和 `Trace(refracted_ray)` 的调用, 这是一个非常清晰的递归关系. 递归的深度由我们预设的最大弹射次数或者光线能量衰减阈值所限制, 这构成了递归的终止条件.

从组合数学的角度看, 解这个递归关系的过程, 就是在展开一棵 **光路树 (Light Path Tree)**. 树的根节点是主光线 (Primary Ray), 每个子节点是经过反射或折射产生的新光线. 这棵树的节点总数, 直接关系到单次像素着色的计算成本. 分析这棵树的结构、深度和分支因子, 对于评估和优化算法性能至关重要. 例如, 通过设置合理的递归深度, 我们实际上是在对这个无限的递归关系进行截断, 这是一种在精度和性能之间的权衡.

### 3. 组合优化: 加速结构 (Acceleration Structure) 的构建

如前所述, 对每条光线都测试场景中所有物体是不可行的. 如何快速找到光线与 "哪个" 物体相交? 这个问题本质上是一个 **组合优化问题**. 我们的目标是, 在所有可能的求交测试顺序和分组中, 找到一种能最小化平均求交次数的方案.

这催生了图形学中一个极其重要的研究领域: **加速结构**. 其中最经典和常用的是 **层次包围盒 (Bounding Volume Hierarchy, BVH)**.

- **问题定义:** 给定一个包含 N 个物体的集合, 如何构建一棵二叉树, 使得树的叶子节点是单个物体, 每个中间节点是一个 "包围盒" (通常是轴对齐包围盒, AABB), 该包围盒紧紧包住其所有子节点的包围盒.
- **组合本质:** 构建一个 "最优" 的 BVH 树是一个 NP-Hard 问题. 因为对于 N 个物体, 可以构建的二叉树形态数量是 **卡特兰数 (Catalan number)**, 这是一个指数级增长的组合问题. 我们无法遍历所有可能的树结构来找到最优解.
- **组合优化算法的应用:** 因此, 在实践中, 我们使用启发式算法 (Heuristic Algorithms) 来近似求解这个组合优化问题. 最著名的启发式方法是 **表面积启发式 (Surface Area Heuristic, SAH)**. SAH 的核心思想是: 分割一个节点中的物体集合时, 我们尝试所有可能的分割方案 (例如, 按 X、Y、Z 轴的不同位置分割), 并为每种分割计算一个 "代价函数".
	- `Cost(split) = C_traversal + P(hit_left) * Cost(left) + P(hit_right) * Cost(right)`
	- 其中, `C_traversal` 是遍历当前节点的固定开销. `P(hit_left)` 是光线与左子节点包围盒相交的概率, SAH 用包围盒的表面积来近似这个概率. `Cost(left)` 是左子树的物体数量.
	- 我们选择使这个成本函数最小化的分割方案. 这是一种 **贪心算法 (Greedy Algorithm)**, 它在每一步都做出局部最优的选择, 以期达到全局近似最优. 这正是组合优化算法简介中所讨论的典型策略.

因此, 每次我们构建一个 BVH, 实际上都在求解一个复杂的组合优化问题. BVH 的效率直接决定了光线追踪的性能, 而其构建算法的优劣, 则取决于我们选择的组合优化策略.

### 4. 鸽巢原理: 空间划分与负载均衡

**鸽巢原理 (Pigeonhole Principle)** 虽然简单, 却能提供对某些问题本质的深刻洞察. 在光线追踪中, 它能帮助我们理解另一类加速结构 --- **空间划分 (Spatial Subdivision)**, 如均匀网格 (Uniform Grid) 或 K-D 树 (K-D Tree) 的性能特点和挑战.

- **模型:** 我们将三维空间划分为一个个不重叠的单元格 (Voxel), 这就是 "**鸽巢**". 场景中的三角面片等几何基元, 就是 "**鸽子**". 我们将每个三角面片放入它所占据的所有单元格中.
- **应用鸽巢原理**:
	1. **必然的碰撞:** 如果场景中的三角面片数量 (鸽子) 远大于我们划分的单元格数量 (鸽巢) , 那么根据鸽巢原理, 必然至少有一个单元格中包含了多个三角面片. 这解释了为什么在实现网格加速结构时, 每个单元格必须存储一个物体列表, 而不是单个物体指针.
	2. **"茶壶在体育场" 问题:** 这是一个经典的场景, 一个巨大的空间 (体育场) 中, 只包含一个精细但局部化的模型 (茶壶) . 如果我们使用均匀网格, 大量的单元格是空的, 而包含茶壶的少数几个单元格则 "挤满" 了成千上万个三角面片. 这就像把所有的鸽子都赶进了少数几个鸽巢里. 当光线穿过这些拥挤的单元格时, 其性能会急剧下降, 退化为无加速结构的情况. 鸽巢原理在这里揭示了**负载不均衡** 的根本问题, 并启发我们去寻求更自适应的划分策略, 如 K-D 树或八叉树, 它们会根据 "鸽子" 的分布来动态调整 "鸽巢" 的大小和位置.

### 5. 容斥原理：构造实体几何 (CSG) 的求交

**容斥原理 (Inclusion-Exclusion Principle)** 在计算集合的并集大小时非常有用. 在图形学中, 这个原理在 **构造实体几何 (Constructive Solid Geometry, CSG)** 中有着直接的几何体现.

CSG 允许我们用简单的基本体 (球、立方体、圆柱等) 通过布尔运算 (并、交、差) 来构建复杂的模型. 例如, 一个带孔的螺母可以被描述为 "一个六棱柱" **减去** "一个圆柱".

当一条光线与一个 CSG 物体求交时, 我们如何计算交点呢?

- **并集 (A ∪ B):** 光线与 `A ∪ B` 的交集, 是光线与 `A` 的交集区间 和 光线与 `B` 的交集区间 的 **并集**.
- **交集 (A ∩ B):** 光线与 `A ∩ B` 的交集, 是光线与 `A` 的交集区间 和 光线与 `B` 的交集区间 的 **交集**.
- **差集 (A - B):** 这是容斥原理最直观的应用. 光线与 `A - B` 的交集, 是光线与 `A` 的交集区间 **减去** 光线与 `B` 的交集区间. 这个 "减去" 操作, 正是一种几何上的 "容斥".

具体来说, 当一条光线 `r(t) = o + t * d` 与物体 `A` 和 `B` 分别求交时, 我们会得到两组交点的参数 `t` 值区间列表, 例如 `Intervals(A)` 和 `Intervals(B)`. 要计算 `A - B` 的交点, 我们需要从 `Intervals(A)` 中, 挖掉 `Intervals(B)` 所覆盖的部分. 这个过程需要对区间端点进行排序和合并, 其逻辑与容斥原理计算集合元素个数的过程高度相似.

### 6. 母函数与排列组合: 路径积分的理论分析

这是更理论化的一层联系. 现代的真实感渲染主要基于 **路径追踪 (Path Tracing)**, 它是光线追踪的一种蒙特卡洛 (Monte Carlo) 变体. 路径追踪的核心是估算渲染方程这个无穷级数 (所有光路贡献的总和).

我们可以从一个组合计数的角度来理解它:

- **路径计数:** 假设光线每次弹射后, 会根据 BRDF (双向反射分布函数) 随机选择一个新方向. 我们可以问: 长度为 $k$ (弹射 $k - 1$ 次) 的光路有多少种 "有意义" 的贡献方式?
- **母函数 (Generating Functions) 的应用:** 我们可以构想一个理论模型. 令 $a_k$ 代表所有长度为 $k$ 的光路对最终图像的平均贡献权重. 我们可以定义一个母函数 $G(x) = \sum a_k x^k$. 这个函数的性质 (如收敛半径、系数的增长率) 可以告诉我们关于渲染算法收敛性的信息. 例如, 如果 $a_k$ 衰减得很快, 说明长路径的贡献很小, 我们的路径追踪算法可以设置一个较小的弹射深度, 收敛会很快. 反之, 如果 $a_k$ 衰减缓慢 (例如在充满了镜面和玻璃的场景中) , 则表明我们需要追踪更长的路径, 算法收敛会更慢.

虽然在实际编码中我们不会直接去构造这个母函数, 但这种思维方式, 即 **用一个形式幂级数的系数来编码一个组合序列的属性**, 为我们从理论上分析蒙特卡洛光线追踪的效率、偏差 (bias) 和方差 (variance) 提供了强大的数学框架. 它将复杂的路径采样问题, 转化为了分析一个函数的解析性质.

### 7. 结论

通过本次研究案例的撰写, 我深刻体会到, 组合数学远非一门仅仅关于计数和棋盘问题的抽象学科. 它所提供的系统性思维工具, 对于理解和解决计算机图形学, 尤其是光线追踪领域的根本性挑战, 具有不可替代的价值.

- **递归关系** 揭示了经典光线追踪算法的内在结构.
- **组合优化** 是构建高效 BVH 加速结构的核心, 直接决定了现代光线追踪的性能.
- **鸽巢原理** 帮助我们洞察空间划分算法的负载均衡问题.
- **容斥原理** 为 CSG 建模提供了坚实的几何运算基础.
- **排列组合与母函数** 则为分析更高级的路径追踪算法的收敛性和效率提供了理论武器.

这门课程让我重新审视了图形学中的许多 "想当然" 的算法和数据结构. 我不再仅仅视它们为 "聪明的技巧", 而是能够从更底层的组合结构和优化目标去理解其设计的必然性和精妙之处. 未来, 在研究新的渲染技术, 例如多重重要性采样、自适应采样策略或基于机器学习的降噪时, 我相信组合数学的视角 --- 如何选择最优的样本组合、如何设计高效的搜索策略、如何分析复杂过程的收敛性 --- 将继续为我们提供源源不断的灵感和深刻的洞察力.
